<!DOCTYPE html>
<HTML>
	<head>
		<title>pelagium</title>
		<meta charset="ISO-8859-15">
		<meta name="author" content="Gerald Franz"/>
		<meta name="description" content="turn-based online strategy game"/>
		<meta name="keywords" content="water world,HTML5,javascript"/>
		<meta name="theme-color" content="#cadacf"/>

		<meta name="viewport" content="user-scalable=no, width=device-width" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="white" />
		<link rel="apple-touch-icon" href="/static/icon_island256.png" />
		<link rel="icon" sizes="192x192" href="/static/icon_island192.png" />
		<link rel="shortcut icon" href="/static/favicon.ico" />
		<link rel="manifest" href="/static/manifest.json" />
		<link href='/static/fonts.css' rel='stylesheet' type='text/css'>

		<style type="text/css">
body {
	--text-color-default: rgba(0,0,0,0.5);
	--text-color-select: rgba(255,255,255,0.8);
	--text-color-heading: white;
}

html, body {
	overflow:hidden;
	height:100%;
	margin: 0 auto;
	font-family: 'Montserrat', sans-serif;
	font-size: calc(7vh);
	-webkit-text-size-adjust: 100%;
	text-transform: uppercase;
	color:var(--text-color-default);
	background: url(/static/pelagium.svg) left / contain no-repeat, url(/static/scillies.jpg) 50% / cover rgb(201,219,207);
	touch-action: none;
}

:focus { outline: none; }

#screens {
	height:100%;
	display:flex;
	align-items: center;
	z-index:3;
}

@media (orientation: landscape) {
	#screens {
		margin: 0 10vw;
	}
	ul#scenarios, .stats, #screen_help > div {
		width:80vw;
	}
	#screen_config > canvas {
		position:fixed;
		left: 50vw;
		top: calc(50vh - 120px);
	}
}

@media (orientation: portrait) {
	#screens {
		margin:0 5vw;
	}
	ul#scenarios, .stats, #screen_help > div {
		width:90vw;
	}
}

#screens ul {
	margin:0;
	padding:0;
	overflow: hidden;
	white-space: nowrap;
}

#screens li {
	margin:0.1em 0;
	border:0;
	list-style: none;
	font-weight: bold;

	user-select: none;
	-ms-user-select: none;
	-moz-user-select: none;
	-webkit-user-select: none;
}

#screens li:hover {
	cursor: pointer;
	color:var(--text-color-select);
}

h2 {
	margin:0 0 0.1em 0;
	font-size: 100%;
	color: var(--text-color-heading);
	text-shadow:0 0 0.25em rgb(201,219,207);

	user-select: none;
	-ms-user-select: none;
	-moz-user-select: none;
	-webkit-user-select: none;
}

input {
	background: none;
	border: none;
	border-bottom:0.2em solid rgba(255,255,255,0.5);
	font-family: 'Montserrat', sans-serif;
	font-size: 100%;
	font-weight: bold;
	color:var(--text-color-default);
}

#logo {
	position: fixed;
	right:0.5em;
	bottom:0.5em;
	width:1.5em;
	opacity:0.75;
}
#logo:hover {
	opacity: 1.0;
	cursor: pointer;
}

#screen_help > div {
	text-shadow:0 0 0.25em rgb(201,219,207);
	font-size: 66%;
	font-weight: bold;
	margin-bottom:1em;
}
.help_icon {
	width:40px;
	height:40px;
	margin-top:-10px;
}

ul#scenarios {
	overflow-x: scroll;
	font-size: 20px;
}

#scenarios li {
	display:inline;
	position:relative;
	margin-right:2vh;
}
#scenarios canvas, #scenario_preview {
	background: rgb(130,160,200);
}
#scenarios div {
	position:absolute;
	left:0.1em;
	bottom:0.1em;
}
#scenarios li:hover {
	text-shadow:0 0 2px rgb(153,179,205);
}

#custom_scenario {
	width:75vw;
}
#custom_scenario input {
	width:69vw;
}
#custom_scenario svg {
	width:5vw;
	height:5vw;
	opacity:0.75;
}
#custom_scenario svg:hover { opacity:1.0; }

.stats {
	overflow-x:scroll;
	white-space: nowrap;
	font-size: 50%;
	font-weight: bold;
	text-align: center;
	background-color: rgba(201,219,207, 0.5);
}
.stats_cell {
	display: inline-block;
	position: relative;
	width:16vw;
	height: 1em;
	margin:0.2em;
	padding:0.1em 0.5em;
}
.stats_figure {
	position:absolute;
	top:0;
	width:100%;
	height:100%;
	z-index: 2;
	background-color: rgba(0,0,0,0.25);
}
.stats_caption {
	position:absolute;
	padding-top:0.15em;
	width:100%;
	height:100%;
	font-size: 70%;
	z-index: 0;
}
.stats_bar {
	position:absolute;
	top:0;
	height:100%;
	z-index:1;
	opacity: 0.5;
}
#stats > div > div:first-child {
	width: 25vw;
	text-align: left;
}

/*--- screen_config ---*/

ul#parties > li {
	margin-bottom:0.5em;
}
ul#parties > li:hover {
	color:var(--text-color-default);
	cursor: default;
}

li.party > div {
	font-size: 75%;
}
ul.party_player {
	font-size:50%;
	background-color: rgba(201,219,207, 0.5);
}
.party_player > li, .btn_row > li {
	display:inline;
	padding-right:0.5em;
	z-index:3;
}

.selected {
	color:var(--text-color-heading);
}
		</style>

		<script type="text/javascript" src="/static/infra.js"></script>
		<script type="text/javascript" src="/static/renderer.js"></script>
		<script type="text/javascript" src="/static/seedrandom.js"></script>
		<script type="text/javascript" src="/static/masterdata.js"></script>
		<script type="text/javascript" src="/static/shared.js"></script>
		<script type="text/javascript">
if ('serviceWorker' in navigator) { /*
	navigator.serviceWorker.register('/serviceworker.js', {scope:'/'})
		.then(() => console.log('service worker installed'))
		.catch(err => console.error('Error', err)); */
}

let StatsTable = function(table) {
	this.colName = function(col, value) {
		return this.set(0, col, value)
	}
	this.rowName = function(row, value) {
		return this.set(row, 0, value);
	}
	this.set = function(row, col, value) {
		while(table.children.length <= row)
			table.appendChild(document.createElement('div'));
		let tr = table.children[row];
		while(tr.children.length <= col) {
			let td = document.createElement('div');
			td.className = 'stats_cell';
			tr.appendChild(td);
			let div = document.createElement('div');
			div.className = (row>0 && col>0) ? 'stats_figure' : 'stats_caption';
			td.appendChild(div);
		}
		let td = tr.children[col];
		td.lastChild.innerHTML = value;
		return this;
	}
	this.progress = function(row, col, fraction, color, opacity) {
		if(typeof fraction != 'number')
			fraction = 0;
		let td = table.children[row].children[col];
		if(td.children.length==1)
			td.insertBefore(document.createElement('div'), td.firstChild);
		let bar = td.firstChild;
		bar.className = 'stats_bar';
		bar.innerHTML = '&nbsp;';
		bar.style.width = (100*fraction)+'%';
		bar.style.backgroundColor = color;
		return this;
	}
}

app = {
	//--- general controller methods ---
	screen: function(screen, display) {
		eludi.switchToSibling('screen_'+screen, display);
	},
	onEnter: function(event, callback) {
		if (event.which == 13 || event.keyCode == 13) {
			callback();
			return false; // do not propagate event
		}
		return true;
	},
	openUrl: function(url, params) {
		eludi.openUrl(url, params, false);
	},
	//--- specific functionality ---
	init: function(params) {
		if(localStorage && localStorage.pelagium) {
			var settings = JSON.parse(localStorage.pelagium);
			if(settings.resume)
			 	document.getElementById("resume_id").value = settings.resume;
		}
		http.get('/pelagium/scenarios', null, function(data, code) {
			if(code!=200)
				return console.error('loading scenario data failed', code, data);
			this.addScenarios(data);
		}, this);

		if(params.screen) {
			this.screen(params.screen);
			if(typeof this[params.screen] == 'function')
				this[params.screen](params);
		}
		this.fillTerrainTable();
		this.fillUnitTable();
	},
	drawMap: function(canvas, data) {
		var dc = canvas.getContext('2d');
		if(!('hex' in dc))
			extendCanvasContext(dc);

		var map = new MapHex(data);
		var page = map.page;
		for(var x=0; x<page.width; ++x) for(var y=0; y<page.height; ++y) {
			var tile = page.get(x,y);
			if(tile.terrain!=MD.WATER)
				continue;
			var pos = { x:x, y:y };
			var nb = null;
			for(var i=0; i<6 && !nb; ++i) {
				nb = page.getNeighbor(pos, i);
				if(nb && nb.terrain==MD.WATER)
					nb=null;
			}
			if(!nb)
				tile.color=null;
		}

		var vp = { x:-2, y:1, width:page.width+2, height:page.height-2 };
		var cellMetrics = MapHex.calculateCellMetrics(canvas.height/(page.height-2));
		if('devicePixelRatio' in window && window.devicePixelRatio!=1.0) {
			canvas.style.width = canvas.width + 'px';
			canvas.style.height = canvas.height + 'px';
			canvas.width *= window.devicePixelRatio;
			canvas.height *= window.devicePixelRatio;
			dc.scale(window.devicePixelRatio, window.devicePixelRatio);
		}
		MapHex.draw(canvas, page, vp, cellMetrics);
	},
	addScenarios: function(data) {
		this.scenarios = data;

		let parent = document.getElementById("scenarios");
		for(let id in data) {
			let li = parent.firstChild.cloneNode(true);
			li.style.display='';
			li.dataset.id = id;
			li.querySelector('div').innerHTML = id;
			let canvas = li.querySelector('canvas');
			canvas.id = 'preview_'+id;
			this.drawMap(canvas, data[id]);
			parent.appendChild(li);
		}
	},
	start: function(scenario) {
		if(!navigator.onLine && location.hostname != 'localhost')
			return alert('server connection required for starting a new game');
		let params = {cmd:'start'};
		if(!scenario) {
			let config = this.readConfig();
			if(config) {
				scenario = config.scenario;
				params.parties = config.parties;
			}
		}
		if(scenario) {
			params.scenario = scenario;
			this.openUrl('/static/pelagium.html', params);
		}
	},
	configure: function(scenId) {
		const switchClassId = (elem, classId='selected')=>{
			let parent = elem.parentElement;
			for(let el = parent.firstElementChild; el!=null; el=el.nextElementSibling)
				if(el == elem)
					el.classList.add(classId);
				else
					el.classList.remove(classId);
			parent.dataset.value = elem.dataset.value;
		};
		let screen = document.getElementById("screen_config");
		screen.querySelector('h2').innerHTML = screen.dataset.id = scenId;

		let canvas = screen.querySelector('canvas');
		let dc = canvas.getContext('2d');
		dc.clearRect(0,0, canvas.width, canvas.height);
		dc.drawImage(document.querySelector('#preview_'+scenId), 0,0, canvas.width, canvas.height);

		let scenario = this.scenarios[scenId];
		let parent = screen.querySelector('#parties');
		while(parent.childElementCount>1)
			parent.removeChild(parent.lastChild);
		let startsCounter = 0;
		for(let id in scenario.starts) {
			let li = parent.firstChild.cloneNode(true);
			li.style.display='';
			li.dataset.id = id;
			li.querySelector('div').innerHTML = MD.Party[id].name;
			let radioPartyType = li.querySelector('.party_player');
			radioPartyType.addEventListener('click', (evt)=>{ switchClassId(evt.target); });
			if(startsCounter < 2)
				switchClassId(radioPartyType.children[startsCounter]);
			else
				switchClassId(radioPartyType.children[3]);
			parent.appendChild(li);
			++startsCounter;
		}
		this.screen('config');
	},
	readConfig: function() {
		let scenId = document.getElementById("screen_config").dataset.id;
		let parties = {};
		let parent = document.querySelector('#parties');

		let selfFound = 0, opponentsFound = 0;
		for(let el = parent.firstElementChild; el!=null; el=el.nextElementSibling) {
			if(typeof el.dataset.id == 'undefined')
				continue;
			let radioPartyType = el.querySelector('.party_player');
			parties[el.dataset.id] = parseInt(radioPartyType.dataset.value, 10);
			switch(parties[el.dataset.id]) {
			case 0:
				++selfFound; break;
			case 1:
			case 2:
				++opponentsFound;
			}
		}
		if(selfFound!=1)
			return alert('choose one color for you');
		if(!opponentsFound)
			return alert('choose at least one A.I. or human foe');

		return { scenario:scenId, parties:parties };
	},
	resume: function() {
		var id = document.getElementById("resume_id").value.toUpperCase();
		if(id.length)
			this.openUrl('/static/pelagium.html', {cmd:'resume', id:id});
	},
	join: function() {
		if(!navigator.onLine)
			return alert('server connection required for joining a game');
		var id = document.getElementById("join_id").value.toUpperCase();
		if(id.length)
			this.openUrl('/static/pelagium.html', {cmd:'join', id:id});
	},
	over: function(params) {
		let isWinner = false;
		for(let i=0; i<params.winners.length && !isWinner; ++i)
			if(params.winners[i]==params.party)
				isWinner = true;
		if(isWinner) {
			document.querySelector("#h_game_over").style.display = 'none';
			document.querySelector("#h_victory").style.display = '';
		}

		let maxValue = function(obj, key) {
			let value = Number.MIN_VALUE;
			for(let id in obj)
				if(key in obj[id])
					value = Math.max(obj[id][key], value);
			return value;
		}

		let table = new StatsTable(document.querySelector("#stats"));
		table.rowName(1, "objectives").rowName(2, "units").rowName(3, "units built")
			.rowName(4, "battles won").rowName(5, "odds").rowName(6, "score");

		for(let id in params.stats) {
			let party = params.stats[id];
			let objValue = (params.capitulated==id) ? 0 : 100;
			party.score = party.objectives*objValue + party.units*10 + party.victories * 20;
		}

		let maxObjectives = maxValue(params.stats, 'objectives');
		let maxUnits = maxValue(params.stats, 'units');
		let maxUnitsBuilt = maxValue(params.stats, 'unitsBuilt');
		let maxScore =  maxValue(params.stats, 'score');
		let opacity = 0.5;

		let col = 1;
		for(let id in params.stats) {
			let party = params.stats[id];
			table.colName(col, MD.Party[id].name);
			table.set(1, col, party.objectives).progress(1, id, party.objectives/maxObjectives, MD.Party[id].color, opacity);
			table.set(2, col, party.units).progress(2, id, party.units/maxUnits, MD.Party[id].color, opacity);
			table.set(3, col, party.unitsBuilt).progress(3, id, party.unitsBuilt/maxUnitsBuilt, MD.Party[id].color, opacity);
			table.set(4, col, party.victories || 0).progress(4, id, party.victories/(party.victories+party.defeats), MD.Party[id].color, opacity);
			table.set(5, col, party.odds.toFixed(2)).progress(5, id, party.odds, MD.Party[id].color, opacity);
			table.set(6, col, party.score).progress(6, id, party.score/maxScore, MD.Party[id].color, opacity);
			++col;
		}
	},
	fillTerrainTable: function() {
		let table = new StatsTable(document.querySelector("#terrain"));
		table.rowName(1,'symbol').rowName(2, "defense").rowName(3, "movement").rowName(4, "concealm.");

		for(let i=0, col=1; i<MD.Terrain.length; ++i, ++col) {
			const terrain = MD.Terrain[i];

			table.set(1, col, '<canvas id="icon_terrain_'+terrain.id+'" class="help_icon"></canvas>');
			let canvas = document.querySelector('#icon_terrain_'+terrain.id);
			canvas.width = canvas.height = 40;
			let dc = extendCanvasContext(canvas.getContext('2d'));
			dc.hex(canvas.width/2, canvas.height/2, canvas.height/2, {fillStyle:terrain.color});
			canvas.parentNode.style.background = 'none';

			table.colName(col, terrain.name);
			table.set(2, col, terrain.defend).set(3, col, terrain.move).set(4, col, terrain.concealment);
		}
	},
	fillUnitTable: function() {
		let table = new StatsTable(document.querySelector("#units"));
		table.rowName(1,'symbol').rowName(2, "moves").rowName(3, "attack")
			.rowName(4, "defense").rowName(5, "support").rowName(6, "range")
			.rowName(7, "visual r.").rowName(8, "retreat").rowName(9, "cost");

		let col = 1;
		for(let id in MD.Unit) {
			const unit = MD.Unit[id];

			table.set(1, col, '<canvas id="icon_'+unit.id+'" class="help_icon"></canvas>');
			let canvas = document.querySelector('#icon_'+unit.id);
			canvas.width = canvas.height = 40;
			let dc = extendCanvasContext(canvas.getContext('2d'));
			dc.fillStyle = MD.Party[1].color;
			dc.fillRect(0,0, canvas.width, canvas.height);
			dc.strokeUnit(id, canvas.width, canvas.height, 7, 'white');
			canvas.parentNode.style.background = 'none';

			table.colName(col, unit.name);
			table.set(2, col, unit.move).set(3, col, unit.attack).set(4, col, unit.defend);
			table.set(5, col, unit.support).set(6, col, unit.range).set(7, col, unit.visualRange);
			table.set(8, col, (unit.retreat*10)+'%').set(9, col, unit.cost);
			++col;
		}
	},
	close: function() {
		window.close();
	},
	scenarios: null
}
document.addEventListener("DOMContentLoaded", ()=>{
	app.init(eludi.paramsRequest());
});
		</script>
	</head>

	<body
		><img id="logo" src="/static/eludi.logo.svg" onclick="document.location.href='https://eludi.net';" alt="eludi.net"
		><div id="screens"
			><ul id="screen_main"
				><li class="l10n" onclick="app.screen('scenario');">start game</li
				><li class="l10n" onclick="app.screen('resume');">resume</li
				><li class="l10n" onclick="app.screen('join');">join game</li
				><li class="l10n" onclick="app.screen('help')">about&hellip;</li
			></ul

			><div id="screen_help" style="display:none;"
				><h2 class="l10n">about&hellip;</h2
				><div class="l10n">Pelagium is a fast-paced strategy game.
					Secure all objectives against your opponents!</div
				><ul
					><li class="l10n" onclick="app.screen('help_units');">units</li
					><li class="l10n" onclick="app.screen('help_terrain');">terrain</li
					><li class="l10n" onclick="app.screen('main')">back</li
				></ul
			></div

			><div id="screen_resume" style="display:none;"
				><h2 class="l10n">resume game</h2
				><input type="text" id="resume_id" placeholder ="id" size="6" maxlength="6"
					onkeypress="app.onEnter(event, function() { app.resume(); });"
				/><ul
					><li onclick="app.resume();"><span class ="l10n">resume</span></li
					><li onclick="app.screen('main');"><span class ="l10n">back</span></li
				></ul
			></div

			><div id="screen_join" style="display:none;"
				><h2 class="l10n">join game</h2
				><input type="text" id="join_id" placeholder ="id" size="6" maxlength="6"
					onkeypress="app.onEnter(event, function() { app.join(); });"
				/><ul
					><li onclick="app.join();"><span class ="l10n">join</span></li
					><li onclick="app.screen('main');"><span class ="l10n">back</span></li
				></ul
			></div

			><div id="screen_scenario" style="display:none;"
				><h2 class="l10n">start game</h2
				><div id="custom_scenario"
					><input type="text" id="scenario_id" placeholder="custom scenario" size="12" maxlength="20"
						onkeypress="app.onEnter(event, ()=>{ app.start(event.target.value); });"
					/><svg onclick="app.start(document.getElementById('scenario_id').value);"
						viewbox="0 0 10 10"><path style="fill:white;stroke:none;" d="M 1 1 l0 8 l8 -4 z"></path></svg
				></div
				><ul id="scenarios"
					><li class="scenario_preview" style="display:none;"
						data-id="default" onclick="app.configure(event.currentTarget.dataset.id);"
						><canvas width="240" height="240"></canvas
						><div>scenario name</div
					></li
				></ul
				><ul
					><li onclick="app.screen('main');"><span class ="l10n">back</span></li
				></ul
			></div

			><div id="screen_config" style="display:none;"
				><h2 class="l10n">scenario configuration</h2
				><canvas id="scenario_preview" width="240" height="240"></canvas
				><ul id="parties"
					><li class="party" style="display:none;"
						><div>party name</div
						><ul class="party_player"
							><li data-value="0">you</li
							><li data-value="1">A.I.</li
							><li data-value="2">human</li
							><li data-value="-1">no one</li
						></ul
					></li
				></ul
				><ul class="btn_row"
					><li onclick="app.start();"><span class ="l10n">start</span></li
					><li onclick="app.screen('main');"><span class ="l10n">back</span></li
				></ul
			></div

			><div id="screen_over" style="display:none;"
				><h2 id="h_game_over" class="l10n">game over.</h2
				><h2 id="h_victory" class="l10n" style="display:none;">victory!</h2
				><div id="stats" class="stats"></div
				><ul
					><li onclick="app.screen('main');"><span class ="l10n">continue</span></li
				></ul
			></div

			><div id="screen_help_units" style="display:none;"
				><h2 class="l10n">units</h2
				><div id="units" class="stats"></div
				><ul
					><li onclick="app.screen('help');"><span class ="l10n">back</span></li
				></ul
			></div

			><div id="screen_help_terrain" style="display:none;"
				><h2 class="l10n">terrain</h2
				><div id="terrain" class="stats"></div
				><ul
					><li onclick="app.screen('help');"><span class ="l10n">back</span></li
				></ul
			></div
		></div
	/></body>
</html>
